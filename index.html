<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Radar Chart Widget</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    #container {
      width: 100vw;
      height: 100vh;
      padding: 20px;
      box-sizing: border-box;
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>
<body>
  <div id="container">
    <canvas id="radarChart"></canvas>
  </div>

  <script>
    const sousThematiqueLabels = [
      "SMDD", "GES - Energie", "GES - Bas carbone",
      "Territoire - économie", "Territoire - acteurs locaux", "Territoire - mobilité douce",
      "Santé - air/eau", "Santé - confort visuel", "Santé - confort été", "Santé - inégalités",
      "Biodiv - biodiversité", "Biodiv - sols", "Biodiv - eau",
      "Patrimoine"
    ];

    const programmationFields = [
      "SMDD - Note Programmation",
      "GES - Note Programmation - Energie",
      "GES - Note Programmation - Bas carbone",
      "Territoire - Note Programmation - économie de projet durable",
      "Territoire - Note Programmation - association des acteurs locaux",
      "Territoire - Note Programmation - mobilité douce",
      "Santé - Note Programmation - Ventilation/qualité de l'air et de l'eau",
      "Santé - Note Programmation - Confort visuel/acoustique",
      "Santé - Note Programmation - Confort d'été / bioclimatique",
      "Santé - Note Programmation - Réduction des inégalités et sécurité",
      "biodiv & protec écosyst - Note Programmation - Biodiversité",
      "biodiv & protec écosyst - Note Programmation - Lutte contre l'artificialisation des sols",
      "biodiv & protec écosyst - Note Programmation - Préservation de la ressource en eau",
      "Gestion patrimoine - Note Programmation - gestion durable"
    ];

    const conceptionFields = programmationFields.map(f => f.replace("Programmation", "Conception"));
    const travauxFields = programmationFields.map(f => f.replace("Programmation", "Travaux"));

    let radarChart;

    function createRadarChart(labels, dataProg, dataConc, dataTrav) {
      const ctx = document.getElementById('radarChart').getContext('2d');

      if (radarChart) radarChart.destroy();

      radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels,
          datasets: [
            {
              label: 'Programmation',
              data: dataProg,
              borderColor: 'rgb(255, 99, 132)',
              pointBackgroundColor: 'rgb(255, 99, 132)',
              fill: false,
              tension: 0.3
            },
            {
              label: 'Conception',
              data: dataConc,
              borderColor: 'rgb(54, 162, 235)',
              pointBackgroundColor: 'rgb(54, 162, 235)',
              fill: false,
              tension: 0.3
            },
            {
              label: 'Travaux',
              data: dataTrav,
              borderColor: 'rgb(255, 206, 86)',
              pointBackgroundColor: 'rgb(255, 206, 86)',
              fill: false,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            tooltip: { enabled: true }
          },
          scales: {
            r: {
              beginAtZero: true,
              min: 0,
              max: 9,
              ticks: { stepSize: 1 },
              angleLines: { display: true },
              grid: {
                circular: true
              },
              pointLabels: {
                font: { size: 12 },
                callback: function(label) {
                  return label.length > 25 ? label.slice(0, 25) + '…' : label;
                }
              }
            }
          }
        }
      });
    }

    grist.ready();

    grist.onRecord(record => {
      if (!record) return;

      const getValues = (fields) => fields.map(f => Number(record[f]) || 0);

      const dataProg = getValues(programmationFields);
      const dataConc = getValues(conceptionFields);
      const dataTrav = getValues(travauxFields);

      createRadarChart(sousThematiqueLabels, dataProg, dataConc, dataTrav);
    });
  </script>
</body>
</html>
