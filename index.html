<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Radar Chart Widget</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 0; padding: 20px; font-family: sans-serif; }
    #chartContainer { width: 700px; height: 700px; margin: auto; }
    canvas { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="chartContainer">
    <canvas id="radarChart"></canvas>
  </div>

  <script>
    let radarChartInstance = null;

    // CrÃ©e le radar Ã  partir de labels et donnÃ©es 3 phases
    function createRadar(labels, progData, concData, travauxData) {
      console.log('ğŸ”¹ labels:', labels);
      console.log('ğŸ”¹ progData:', progData);
      console.log('ğŸ”¹ concData:', concData);
      console.log('ğŸ”¹ travauxData:', travauxData);

      const ctx = document.getElementById('radarChart').getContext('2d');
      if (radarChartInstance) radarChartInstance.destroy();

      radarChartInstance = new Chart(ctx, {
        type: 'radar',
        data: {
          labels,
          datasets: [
            {
              label: "Programmation",
              data: progData,
              borderColor: "rgb(255, 99, 132)",
              backgroundColor: "rgba(255, 99, 132, 0.2)",
              fill: false,
              pointRadius: 4, tension: 0.3
            },
            {
              label: "Conception",
              data: concData,
              borderColor: "rgb(54, 162, 235)",
              backgroundColor: "rgba(54, 162, 235, 0.2)",
              fill: false,
              pointRadius: 4, tension: 0.3
            },
            {
              label: "Travaux",
              data: travauxData,
              borderColor: "rgb(255, 206, 86)",
              backgroundColor: "rgba(255, 206, 86, 0.2)",
              fill: false,
              pointRadius: 4, tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            r: {
              beginAtZero: true,
              ticks: { stepSize: 1 },
              backdropColor: 'transparent'
            }
          },
          plugins: { legend: { position: 'top' } }
        }
      });
    }

    // Lecture des donnÃ©es Grist
    grist.ready();
    grist.onRecords(records => {
      if (!records || records.length === 0) return;

      const labels = [];
      const progData = [], concData = [], travauxData = [];

      records.forEach(r => {
        labels.push(r["ST ref"] || '');
        progData.push(r["Programmation/5"] != null ? r["Programmation/5"] : 0);
        concData.push(r["Conception/5"] != null ? r["Conception/5"] : 0);
        travauxData.push(r["Travaux/5"] != null ? r["Travaux/5"] : 0);
      });

      // Si tous les tableaux sont nuls ou vides, on montre un exemple
      const isEmpty = progData.every(v => v === 0)
                   && concData.every(v => v === 0)
                   && travauxData.every(v => v === 0);

      if (isEmpty) {
        console.warn("ğŸ”„ DonnÃ©es vides dÃ©tectÃ©es, affichage du jeu de test.");
        createRadar(
          ['ST A','ST B','ST C','ST D'],
          [3,4,2,5],
          [2,3,4,1],
          [5,4,3,2]
        );
      } else {
        createRadar(labels, progData, concData, travauxData);
      }
    });
  </script>
</body>
</html>
